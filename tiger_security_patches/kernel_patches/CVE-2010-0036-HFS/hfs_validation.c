#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>

// CVE-2010-0036 HFS+ Integer Overflow Protection
// Validate HFS+ catalog operations

typedef struct {
    uint16_t recordType;
    uint16_t flags;
    uint32_t valence;
    uint32_t fileID;
} HFSCatalogFolder;

typedef struct {
    uint32_t logicalSize;
    uint32_t totalBlocks;
    uint32_t blockSize;
} HFSExtentDescriptor;

// Validate HFS+ extent calculations
int validate_hfs_extent(HFSExtentDescriptor *extent) {
    if (!extent) return 0;
    
    // Check for integer overflow in size calculations
    uint64_t totalSize = (uint64_t)extent->totalBlocks * extent->blockSize;
    
    // Ensure block size is reasonable
    if (extent->blockSize < 512 || extent->blockSize > 65536) {
        return 0;
    }
    
    // Check for overflow
    if (totalSize > 0xFFFFFFFF) {
        return 0;
    }
    
    // Logical size should not exceed total size
    if (extent->logicalSize > totalSize) {
        return 0;
    }
    
    return 1;
}

// Validate catalog operations
int validate_catalog_entry(HFSCatalogFolder *folder) {
    if (!folder) return 0;
    
    // Check valence (number of items in folder)
    if (folder->valence > 32767) { // HFS+ limit
        return 0;
    }
    
    // Validate record type
    if (folder->recordType != 0x0001 && folder->recordType != 0x0002) {
        return 0;
    }
    
    return 1;
}

// Safe catalog traversal
int safe_catalog_lookup(uint32_t parentID, const char *name, size_t nameLen) {
    // Would validate all parameters before filesystem operation
    if (nameLen > 255) return -1; // HFS+ name limit
    if (parentID < 2) return -1; // Invalid parent
    
    return 0;
}