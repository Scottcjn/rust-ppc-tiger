#include <ApplicationServices/ApplicationServices.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// CVE-2011-0182 Font Parsing Protection
// Validate font tables before processing

typedef struct {
    uint32_t tag;
    uint32_t checksum;
    uint32_t offset;
    uint32_t length;
} FontTableEntry;

int validate_font_table(const void *fontData, size_t dataSize) {
    if (dataSize < 12) return 0;
    
    // Check TrueType/OpenType signature
    uint32_t *signature = (uint32_t *)fontData;
    if (*signature != 0x00010000 && *signature != 0x74746366 && 
        *signature != 0x4F54544F && *signature != 0x74727565) {
        return 0;
    }
    
    // Validate table directory
    uint16_t numTables = ((uint16_t *)fontData)[2];
    if (numTables > 128) return 0; // Suspicious number of tables
    
    size_t dirSize = 12 + (numTables * 16);
    if (dirSize > dataSize) return 0;
    
    // Check each table entry
    FontTableEntry *tables = (FontTableEntry *)((char *)fontData + 12);
    int i;
    for (i = 0; i < numTables; i++) {
        if (tables[i].offset + tables[i].length > dataSize) {
            return 0; // Table extends beyond file
        }
    }
    
    return 1; // Valid
}

// Hook font loading functions
ATSFontRef SecureATSFontFindFromName(CFStringRef name, ATSOptionFlags options) {
    // Would validate font before loading
    return ATSFontFindFromName(name, options);
}